-----------------------------------
-- Daily Quest : Secret Chests
-- Spawns Secret Treasure Chests in certain zones
-----------------------------------
require("modules/module_utils")
require("scripts/globals/zone")
-----------------------------------
local m = Module:new("daily_quest_secretchests")

local handleMidnight = function(player)
    local questMidnight = player:getCharVar("[DailyQuest]Midnight")
    local currentMidnight = getMidnight()

    -- handle first time quest midnight
    if questMidnight == 0 then
        player:setCharVar("[DailyQuest]Midnight",currentMidnight)
        player:setCharVar("[DailyQuest]Completed",0)
        player:setCharVar("[DailyQuest]Fishstix",0)
        player:setCharVar("[DailyQuest]Murdoc",0)
        player:setCharVar("[DailyQuest]Mistrix",0)
        player:setCharVar("[DailyQuest]Saltlik",0)
        player:setCharVar("[DailyQuest]Beetrix",0)
    end
    
    -- handle midnight reset
    if currentMidnight < questMidnight then
        player:setCharVar("[DailyQuest]Midnight",currentMidnight)
        player:setCharVar("[DailyQuest]Completed",0)
        player:setCharVar("[DailyQuest]Fishstix",0)
        player:setCharVar("[DailyQuest]Murdoc",0)
        player:setCharVar("[DailyQuest]Mistrix",0)
        player:setCharVar("[DailyQuest]Saltlik",0)
        player:setCharVar("[DailyQuest]Beetrix",0)
    end
end

local treasureCostumeID = 267
local treasurePositions =
{
    -- Zone Num | Zone Name | Zone ID | POS Locations
    {1,"West_Ronfaure",                 100,{{-29,-60,219,87},{-178,-60,317,128},{-547.2,-59.6,517.5,158},{-483.5,-46.7,226.7,8},{-236,-40,63,243},{-294.65,-32.33,-26.1,132},{-454.77,-32.33,14.25,121},{-614.63,-24.57,-151.53,242},{-521.7,0,-438.05,166},{-289.07,0.5,-521.45,97},{-181.4,0,-501.3,98},{-68.55,-0.16,-538.55,193},{-50.54,-9.5,-398.48,0}}},
    {2,"East_Ronfaure",                 101,{{220.486,0,-538.182,190},{249.895,0,-538.190,190},{289.832,0,-501.681,60},{263.351,0,-501.572,60},{330.044,0,-538.601,190},{321.404,-60,522.386,61},{420.042,-65.732,445.202,99},{498.765,-60.038,469.305,192},{507.972,-60.011,458.204,1},{767.483,-61.362,400.100,130}}},
    {3,"South_Gustaberg",               107,{{-493.839,40,-482.177,202},{-423.172,43.698,-461.885,174},{-289.327,21.262,-382.687,252},{-264.201,18.452,-313.208,84},{-191.268,17.982,-427.840,128},{-123.347,18.781,-483.586,222},{70.422,-5.777,-463.857,98},{363.695,-1.236,684.129,158},{520.142,-2.924,736.791,189}}},
    {4,"North_Gustaberg",               106,{{-589.808,40,54.876,222},{-437.971,0,479.694,0},{506.035,0.301,428.598,5},{441.289,0,405.997,43},{320.726,-2.797,329.384,58},{200.299,0.055,324.101,94},{150.093,-5.715,336.141,83},{129.516,-2.763,399.964,115},{86.767,0.459,527.733,122},{-74.624,-0.077,599.272,4}}},
    {5,"West_Sarutabaruta",             115,{{-370.861,-22.244,216.441,252},{-411.797,-17.725,327.605,1},{-258.004,-17.250,660.441,254},{-189.890,-26.054,496.843,128},{-5.394,-12.484,308.276,64},{238.214,-9.900,40.014,0},{-1.329,0,-156.606,39},{-61.796,-6.163,-250.548,191},{-121.292,-4.941,-287.890,188},{104.838,-0.931,-203.319,122}}},
    {6,"East_Sarutabaruta",             116,{{233.289,-24.662,560.574,6},{-59.756,-37.250,734.799,63},{-273.952,-22.770,662.066,255},{286.569,-2.700,261.747,255},{446.820,-2.500,298.321,127},{378.862,-13.250,99.907,128},{446.889,9.343,-139.345,255},{485.318,9.500,-140.142,121},{-246.174,-3.735,-160.158,34},{-351.037,-3.057,-130.521,117}}},
    {7,"La_Theine_Plateau",             102,{{-266.886,4.334,291.993,114},{-441.370,6.356,229.318,66},{-449.020,-8.029,293.092,135},{-607.264,0.083,474.459,100},{-561.724,0,637.696,177},{-180.001,8.820,254.831,36},{338.781,19.104,-63.751,144},{434.970,24,22.074,198},{748.774,29.002,-16.079,242},{563.891,41.371,-427.724,124}}},
    {8,"Konschtat_Highlands",           108,{{563.063,30.777,635.960,154},{458.349,31.260,464.815,152},{233.449,24,300.122,187},{142.523,19.104,223.923,93},{402.982,-1.207,-3.363,154},{-233.059,16.361,199.887,7},{-328.557,16.044,195.746,124},{-705.982,2.818,103.857,237},{-263.467,-49.471,-466.454,206},{94.111,-69.003,-577.422,119}}},
    {9,"Tahrongi_Canyon",               117,{{361.894,-8.946,-87.874,160},{200.877,-24.986,-168.091,188},{-42.281,46.931,-672.194,19},{207.646,15.117,-680.856,118},{90.488,1.173,-109.851,59},{78.790,15.712,114.882,220},{176.975,35.150,262.554,63},{117.653,40,355.244,129},{450.495,46.388,495.988,78},{-152.077,47.044,641.737,129}}},
    {10,"Valkurm_Dunes",                103,{{93.458,-2.327,-112.212,110},{124.903,-7.349,92.950,214},{325.594,-8.250,76.057,153},{368.845,-0.533,-127.749,156},{-269.074,1.901,-158.253,231},{-361.166,0.303,-12.603,10},{-306.172,-11.030,252.209,93},{-468.335,-18.286,366.880,82},{-628.852,-10.691,211.435,95},{-797.904,-6.050,51.110,220}}},
    {11,"Jugner_Forest",                104,{{243.2674,0.0000,-1.9098,162},{332.7855,-1.3893,-218.1996,152},{59.7847,0.5666,-30.2552,52},{-135.6859,0.7641,-160.2753,213},{-122.1466,-8.0000,-522.7593,251},{-62.4835,-20.8025,-659.9227,235},{-20.8877,-4.0700,302.5906,212},{92.4609,0.4849,475.6379,44},{262.9796,0.8255,555.8021,34},{562.7896,0.0971,325.9646,106}}},
    {12,"Batallia_Downs",               105,{{-684.6698,-12.2000,164.7846,30},{-516.8535,-4.2000,-38.3124,98},{-236.4650,-20.2000,-76.6095,99},{-197.8350,-4.2000,38.1056,161},{-61.5022,0.9237,439.5493,7},{-15.2355,3.8000,295.1584,31},{64.4709,-14.5332,140.3338,129},{195.0482,11.8000,-44.7756,226},{338.6655,3.3601,63.3932,149},{145.3150,11.8000,-384.2086,33}}},
    {13,"Pashhow_Marshlands",           109,{{534.9106,24.4139,693.1660,193},{470.0331,24.6623,412.1792,165},{269.0648,25.0000,415.1863,38},{53.6186,24.3043,365.3375,53},{208.8063,25.0000,148.1856,91},{458.2511,24.5071,-10.8369,136},{295.6585,25.2500,-95.0222,52},{243.6703,24.9892,-296.4225,195},{-35.0967,25.0000,-147.0363,84},{-416.9833,24.0898,-228.9177,61}}},
    {14,"Rolanberry_Fields",            110,{{-342.0245,-23.7784,-670.3920,252},{-395.1242,-8.5000,-443.1851,232},{-432.5514,-15.5754,-316.0685,6},{-632.1749,-23.6895,-271.2613,189},{-436.2982,-7.7233,17.4652,230},{-481.7202,0.0000,157.5170,251},{-202.3049,8.0000,362.4264,225},{314.3024,16.0837,321.3084,59},{520.2621,-8.0000,42.1197,85},{242.8125,-31.0329,-259.3657,131}}},
    {15,"Sauromugue_Champaign",         120,{{-129.1338,-25.1600,-400.0967,245},{-117.8947,16.2659,30.6597,61},{-268.8352,8.2690,54.3324,216},{-243.4174,8.0000,243.7835,130},{-205.8423,15.8831,283.7137,115},{-239.8076,15.0635,447.8749,87},{202.6848,31.2921,193.5551,54},{353.3181,23.8305,-3.2562,100},{366.5192,14.9162,-215.2834,184},{421.7435,16.3432,-149.5891,54}}},
    {16,"Beaucedine_Glacier",           111,{{-228.8481,-80.8019,258.8343,167},{-24.6721,-59.6147,-76.0180,63},{-176.8972,-40.2500,-219.7463,255},{99.9957,-20.2500,136.7716,65},{59.2686,-0.2500,-335.2778,191},{-87.6468,0.0165,-369.4749,222},{265.1904,-0.2500,-19.8082,2},{154.1081,-0.0958,120.1986,4},{250.4337,-0.2000,208.6171,101},{271.8987,20.0449,527.1563,89}}},
    {17,"Xarcabard",                    112,{{-139.5488,-21.3258,129.0947,62},{-103.9603,-39.8249,41.4914,155},{-255.0679,-14.9442,-147.0284,187},{-292.9190,-22.7128,147.0915,64},{-411.4244,-44.0000,32.8717,245},{119.3985,-28.7700,-123.1243,156},{57.2033,-28.5111,-193.1673,68},{-23.4988,-24.2179,-496.3124,204},{195.7353,-23.9879,-202.0951,111},{577.5774,-0.4375,-14.1310,198}}},
    {18,"Cape_Teriggan",                113,{{254.8981,2.9751,56.3916,66},{146.7516,2.3398,-195.8009,151},{-188.2556,8.0516,-69.4246,253},{-187.9107,1.5278,-303.2005,233},{-176.0762,3.0037,54.7913,9},{-275.5800,-15.7296,139.2300,15},{116.6077,0.0000,285.1415,57},{176.8529,2.9547,145.2006,134},{16.4720,-5.0054,105.3912,132}}},
    {19,"Eastern_Altepa_Desert",        114,{{225.2773,-11.3020,260.1861,196},{45.0305,-7.9499,398.5899,16},{-55.3194,3.9492,226.3541,134},{-151.4631,-7.5547,345.3339,49},{-307.2764,0.4666,116.3732,97},{-170.6364,8.3949,-170.7187,218},{-258.1786,8.4535,-252.7911,246},{25.9434,10.1992,-264.3477,147},{474.2984,-0.6997,-60.4492,147},{499.9066,2.1992,148.9513,59}}},
    {20,"Western_Altepa_Desert",        125,{{-90.0854,-2.4527,449.0002,36},{146.2338,0.5714,243.5722,186},{-151.8872,-16.7349,20.0748,253},{-145.5451,-15.0902,-12.2120,23},{-212.1482,-14.8574,-15.1000,81},{-332.7083,0.4771,-114.4276,143},{-275.5997,-4.4492,63.7249,104},{-462.1591,-0.0612,261.0957,87},{-201.1693,-2.3585,373.1492,61},{-215.4306,-11.7883,102.5631,172}}},
    {21,"Meriphataud_Mountains",        119,{{728.4697,-33.0483,40.2009,129},{688.9405,-25.1270,161.2462,141},{603.6194,-32.0000,279.9139,87},{121.6685,-8.9222,607.8154,44},{-285.2278,15.6881,600.7204,7},{-289.8122,16.3845,417.9721,100},{-528.8677,-9.1157,198.4571,252},{719.4794,-32.9382,-87.8839,193},{354.2725,-8.0052,-118.2133,172},{202.5027,0.0000,-522.2034,188}}},
    {22,"Buburimu_Peninsula",           118,{{-272.7763,18.2141,-325.9178,26},{33.2192,-0.0064,-196.1049,40},{81.4943,0.0907,-194.1635,155},{357.2985,0.0000,-240.4695,208},{442.1010,0.0000,-318.7705,194},{445.5502,18.2740,193.4318,37},{194.4682,-16.8663,245.2752,25},{-38.0914,-24.0000,279.7069,55},{-345.3481,-24.5464,50.8134,16},{-476.5060,-32.2202,47.6595,196}}},
    {23,"The_Sanctuary_of_ZiTah",       121,{{465.6945,-0.0102,-566.2515,4},{489.0155,0.1602,-278.6891,132},{606.3391,0.4293,-128.9220,77},{337.1624,-0.7646,-140.3643,169},{132.8560,-0.7000,-141.9269,151},{-35.6515,0.2126,-150.7413,193},{-432.3432,0.1817,121.5100,99},{-370.2611,-0.0354,290.9156,145},{-340.1540,0.4012,418.0867,73},{-284.5505,0.0264,523.3145,89}}},
    {24,"RoMaeve",                      122,{{-0.0487,-29.3984,82.5825,192},{-0.2824,-29.3241,60.3875,56},{182.3899,-5.0000,11.6407,96},{221.0516,-6.5400,-97.3868,186},{101.3497,-5.2000,4.1336,84},{161.1452,-6.0000,-114.5502,191},{-116.8099,-4.0708,-114.8103,223},{-95.5379,-1.0000,-83.1229,214},{-147.9766,0.9016,-108.0093,196},{-103.0063,-5.2000,2.6364,36},{-66.1635,-5.2000,23.8956,48}}},
    {25,"Yuhtunga_Jungle",              123,{{-223.5197,-0.1635,498.5134,150},{-261.2157,5.4071,454.5269,253},{-74.6055,-0.2211,445.9792,102},{-308.9467,2.6639,223.0647,1},{-417.5992,8.7174,213.2710,217},{-373.5449,13.0000,-96.8053,158},{-301.0068,4.0596,-102.7879,194},{-417.5006,10.6672,-265.7918,178},{-649.7037,-0.0129,44.0973,28},{-609.2664,0.0000,-121.4595,247}}},
    {26,"Yhoator_Jungle",               124,{{250.3906,0.1698,-532.5775,184},{277.1335,0,-399.6764,192},{215.8089,0.0787,32.6307,194},{91.3226,0,196.0168,150},{-101.8786,-1.4944,52.0368,213},{-253.4885,6.6471,28.4988,93},{-498.4855,8.8406,-188.6802,222},{-459.4060,1.5500,-331.7365,164},{-256.4169,0.0316,-458.8336,195},{1.6,0.1,-347.2178,128}}},
    {27,"Qufim_Island",                 126,{{-267.7306,-19.5779,402.3297,240},{-340.6172,-12.1026,539.2167,9},{-130.7917,-21.4513,413.4923,6},{-111.9717,-19.6915,229.8066,198},{45.2582,-20.0641,283.0483,233},{181.1417,-22.3171,135.8035,221},{167.4396,-21.9135,28.6876,167},{93.4568,-21.5034,-51.1449,32},{-35.4559,-21.7744,-53.7631,110},{173.5320,-21.9593,-28.5420,65},{96.5474,17.9617,-263.3933,19}}},
    {28,"Temple_of_Uggalepih",          159,{{76.4836,0,-39.3,191},{66.4732,1.4603,-60.2844,78},{-210.9982,0,-13.6968,105},{-132.7098,0,-67.8487,64},{-20.5119,0.5,-82.6116,0},{-27.2094,-24.9999,37.7444,96},{-27.4638,-17,-147.8486,65},{267.8488,0,112.7122,1},{347.3,-0.0009,222.8087,127},{425.5971,5.2471,223.3,64}}},
    {29,"Valley_of_Sorrows",            128,{{141.0560,-5.8524,-58.5018,92},{101.4715,-0.3392,-11.4836,199},{-57.2116,-5.0907,55.0726,5},{-104.8795,-5.0855,17.0616,80},{-176.1701,-11.4837,13.2509,120},{-130.4733,-2.4491,-25.5167,15},{-18.7014,-1.5429,-55.3335,155},{36.4795,-0.6639,49.9907,46},{106.1917,-3.9239,-49.5341,216},{99.5238,-9.0230,-103.0284,197}}},
    {30,"Bibiki_Bay",                     4,{{649.2197,-21.1735,838.9446,126},{569.2031,-19.9828,753.0187,119},{477.8183,-5,777.5853,26},{454.0760,-3.0024,729.1177,2},{241.0836,-37.1751,849.2199,63},{146.7451,-37.9250,613.5005,177},{273.1945,-20.7964,602.9559,54},{337.7320,-22.3767,330.3999,55},{335.1253,-16.1852,234.6558,22},{65.3972,-28.7474,221.8518,83},{266.7132,-0.8388,180.6371,110}}},
    {31,"Carpenters_Landing",             2,{}},
    {32,"Uleguerand_Range",               5,{}},
    {33,"Attohwa_Chasm",                  7,{}},
    {34,"Oldton_Movalpolos",             11,{}},
    {35,"Newton_Movalpolos",             12,{}},
    {36,"Wajaom_Woodlands",              51,{}},
    {37,"Bhaflau_Thickets",              52,{}},
    {38,"Arrapago_Reef",                 54,{}},
    {39,"Mount_Zhayolm",                 61,{}},
    {40,"Halvung",                       62,{}},
    {41,"Mamook",                        65,{}},
    {42,"Aydeewa_Subterrane",            68,{}},
    {43,"Alzadaal_Undersea_Ruins",       72,{}},
    {44,"Nyzul_Isle",                    77,{}},
    {45,"Caedarva_Mire",                 79,{}},
    {46,"Yughott_Grotto",               142,{}},
    {47,"Fort_Ghelsba",                 141,{}},
    {48,"Palborough_Mines",             143,{}},
    {49,"Giddeus",                      145,{}},
    {50,"Beadeaux",                     147,{}},
    {51,"Davoi",                        149,{}},
    {52,"Monastic_Cavern",              150,{}},
    {53,"Castle_Oztroja",               151,{}},
    {54,"The_Boyahda_Tree",             153,{}},
    {55,"Lower_Delkfutts_Tower",        184,{}},
    {56,"Middle_Delkfutts_Tower",       157,{}},
    {57,"Upper_Delkfutts_Tower",        158,{}},
    {58,"Den_of_Rancor",                160,{}},
    {59,"Castle_Zvahl_Baileys",         161,{}},
    {60,"Castle_Zvahl_Keep",            162,{}},
    {61,"Ranguemont_Pass",              166,{}},
    {62,"Bostaunieux_Oubliette",        167,{}},
    {63,"Toraimarai_Canal",             169,{}},
    {64,"Zeruhn_Mines",                 172,{}},
    {65,"Korroloka_Tunnel",             173,{}},
    {66,"Kuftal_Tunnel",                174,{}},
    {67,"The_Eldieme_Necropolis",       195,{}},
    {68,"Sea_Serpent_Grotto",           176,{}},
    {69,"Dangruf_Wadi",                 191,{}},
    {70,"Inner_Horutoto_Ruins",         192,{}},
    {71,"Outer_Horutoto_Ruins",         194,{}},
    {72,"Ordelles_Caves",               193,{}},
    {73,"Gusgen_Mines",                 196,{}},
    {74,"Crawlers_Nest",                197,{}},
    {75,"Maze_of_Shakhrami",            198,{}},
    {76,"Garlaige_Citadel",             200,{}},
    {77,"FeiYin",                       204,{}},
    {78,"Ifrits_Cauldron",              205,{}},
    {79,"Quicksand_Caves",              208,{}},
    {80,"Gustav_Tunnel",                212,{}},
    {81,"Labyrinth_of_Onzozo",          213,{}},
    {82,"Dynamis-Bastok",               186,{}},
    {83,"Dynamis-San_dOria",            185,{}},
    {84,"Dynamis-Windurst",             187,{}},
    {85,"Dynamis-Jeuno",                188,{}},
    {86,"Dynamis-Beaucedine",           134,{}},
    {87,"Dynamis-Xarcabard",            135,{}},
    {88,"RuAun_Gardens",                130,{}},
    {89,"VeLugannon_Palace",            177,{}},
    {90,"The_Shrine_of_RuAvitau",       178,{}},
    {91,"AlTaieu",                       33,{}},
    {92,"Grand_Palace_of_HuXzoi",        34,{}},
    {93,"The_Garden_of_RuHmet",          35,{}},
    {94,"Lufaise_Meadows",               24,{}},
    {95,"Misareaux_Coast",               25,{}},
    {96,"Phomiuna_Aqueducts",            27,{}},
    {97,"Sacrarium",                     28,{}},
    {98,"Riverne_Site-A01",              30,{}},
    {99,"Riverne_Site-B01",              29,{}},
    {100,"Escha-ZiTah",                  288,{}},
    {101,"Escha-RuAun",                  289,{}}
}

for _, entry in pairs(treasurePositions) do
if entry[1] == 1 then -- TODO: Delete this line (for testing purposes, forces West Ronfaure)
    local questZoneNum         = entry[1]
    local questZoneName        = entry[2]
    local questZoneID          = entry[3]
    local positionsLength      = #(entry[4])
    local randChestNum = math.random(1,positionsLength)
    local positionX = entry[4][randChestNum][1]
    local positionY = entry[4][randChestNum][2]
    local positionZ = entry[4][randChestNum][3]
    local positionR = entry[4][randChestNum][4]

    --print(string.format("xi.zones.%s.Zone.onInitialize",questZoneName))
    --print(string.format("Chest: x-pos %d, y-pos %d, z-pos %d, rot %d",positionX,positionY,positionZ,positionR))

    m:addOverride(string.format("xi.zones.%s.Zone.onInitialize",questZoneName), function(zone)

        super(zone)

        local dailyQuestChest = zone:insertDynamicEntity({

            objtype = xi.objType.NPC,
            name = "Secret Chest",
            look = treasureCostumeID,
            x = positionX,
            y = positionY,
            z = positionZ,
            rotation = positionR,
            widescan = 0,

            onTrade = function(player, npc, trade)
                player:PrintToPlayer("I don't require any items from you.", 0, npc:getPacketName())
            end,
    
            onTrigger = function(player, npc)
                handleMidnight(player)
                local dailyQuestActive = player:getCharVar("[DailyQuest]Fishstix")
                local dailyQuestZone = player:getCharVar("[DailyQuest]Fishstix_zone")
                local chestOpened = npc:getLocalVar("opened")

                if dailyQuestActive == 1 and dailyQuestZone == questZoneNum and chestOpened == 0 then
                    npc:setLocalVar("opened", 1)
                    player:setCharVar("[DailyQuest]Fishstix",2)
                    player:PrintToPlayer("You found the Secret Treasure Chest, please return to Fishstix to claim your reward!", 17)
                    npc:setAnimation(1)
                    npc:timer(3, function(npc)
                        npc:setStatus(xi.status.DISAPPEAR)
                        repeat
                            randChestNum = math.random(1,positionsLength)
                            newX = entry[4][randChestNum][1]
                            newY = entry[4][randChestNum][2]
                            newZ = entry[4][randChestNum][3]
                            newRot = entry[4][randChestNum][4]
                        until(math.abs(newX - npc:getXPos()) > 1 and math.abs(newZ - npc:getZPos()) > 1)
                        npc:setPos(newX, newY, newZ, newRot)
                        npc:setAnimation(0)
                        npc:setStatus(xi.status.NORMAL)
                        npc:setLocalVar("opened", 0)
                    end)
                else
                    player:PrintToPlayer("This is not for you.", 0, npc:getPacketName())    
                end
            end,
        })

        utils.unused(dailyQuestChest)
    end)
end -- TODO: Delete this line (for testing purposes, forces West Ronfaure)
end

return m
